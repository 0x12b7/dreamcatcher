import{Unsafe as e,Some as r,None as n,Ok as t,Err as E,Fpv as a,flag as R,wrap as u,wrapAsync as i}from"@tokyo/reliq";import{Contract as _,ContractFactory as o,Interface as N,JsonRpcProvider as A,Wallet as I}from"ethers";function T(R){let U;{let l=c(u((()=>new A(R))));return l.err()?l:(U=l.unwrap(),t({query:async function(r){let n=c(u((()=>new I(r.privateKey,U))));if(n.err())return n;let E=n.unwrap(),a=c(u((()=>new _(r.to,[r.signature],E))));if(a.err())return a;let R=a.unwrap(),o=c(u((()=>R.getFunction(r.signature))));if(o.err())return o;let N=o.unwrap(),A=await c(i((async()=>e(await N(...r.payload??[])))));if(A.err())return A;let T=A.unwrap();return t(T)},touch:async function(e){let R=c(u((()=>new I(e.privateKey,U))));if(R.err())return R;let _=R.unwrap(),o=await c(i((async()=>await _.getAddress())));if(o.err())return o;let A=o.unwrap(),l=await c(i((async()=>BigInt(await _.getNonce()))));if(l.err())return l;let M=l.unwrap(),f=c(u((()=>new N([e.signature]))));if(f.err())return f;let s=f.unwrap(),C=T.Signature.nameOf(e.signature);if(C.none())return E({code:"ETHEREUM_VIRTUAL_MACHINE.ERR_MALFORMED_SIGNATURE",data:n,message:n,reason:n,transaction:n});let w=C.unwrap(),L=c(u((()=>s.encodeFunctionData(w,e.payload))));if(L.err())return L;let H=L.unwrap(),p=e.gasPrice?a.Calculator.unwrap(e.gasPrice):0n,d=e.gasLimit?a.Calculator.unwrap(e.gasLimit):0n,O=await c(i((async()=>await _.sendTransaction({from:A,to:e.to,nonce:Number(M),gasPrice:p,gasLimit:d,data:H}))));if(O.err())return O;let D=O.unwrap();if(null===D)return E({code:"ETHEREUM_VIRTUAL_MACHINE.ERR_INVALID_RESPONSE",data:n,message:n,transaction:n,reason:n});let S=await c(i((async()=>await D.wait(Number(e.confirmations),Number(e.timeout)))));if(S.err())return S;let g=S.unwrap();return t(null===g?n:r(g))},deploy:async function(e){let r=c(u((()=>new I(e.privateKey,U))));if(r.err())return r;let n=r.unwrap(),E=c(u((()=>new o(e.abi,e.bytecode,n))));if(E.err())return E;let a=E.unwrap(),R=await c(i((async()=>await a.deploy(e.payload))));if(R.err())return R;let _=R.unwrap(),N=await c(i((async()=>await _.getAddress())));if(N.err())return N;let A=N.unwrap();return t(A)}}))}function c(e){if("then"in e){return e.then((e=>c(e)))}if("ok"in e){return e.mapErr((e=>c(e)))}let t=e.inspect();if(null==t||"object"!=typeof t||!("code"in t)||"string"!=typeof t.code)return{code:"ETHEREUM_VIRTUAL_MACHINE.ERR_UNKNOWN",data:n,message:n,transaction:n,reason:n};let E="UNKNOWN_ERROR"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_UNKNOWN":"NOT_IMPLEMENTED"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_NOT_IMPLEMENTED":"UNSUPPORTED_OPERATION"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_UNSUPPORTED_OPERATION":"NETWORK_ERROR"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_NETWORK_FAULT":"SERVER_ERROR"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_SERVER_FAULT":"TIMEOUT"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_TIMEOUT":"BAD_DATA"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_BAD_DATA":"CANCELLED"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_CANCELLED":"BUFFER_OVERRUN"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_BUFFER_OVERRUN":"NUMERIC_FAULT"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_NUMERIC_FAULT":"INVALID_ARGUMENT"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_INVALID_ARGUMENT":"MISSING_ARGUMENT"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_MISSING_ARGUMENT":"UNEXPECTED_ARGUMENT"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_UNEXPECTED_ARGUMENT":"CALL_EXCEPTION"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_CALL_EXCEPTION":"INSUFFICIENT_FUNDS"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_INSUFFICIENT_FUNDS":"NONCE_EXPIRED"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_NONCE_EXPIRED":"REPLACEMENT_UNDERPRICED"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_REPLACEMENT_UNDERPRICED":"TRANSACTION_REPLACED"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_TRANSACTION_REPLACED":"UNCONFIGURED_NAME"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_UNCONFIGURED_NAME":"OFFCHAIN_FAULT"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_OFFCHAIN_FAULT":"ACTION_REJECTED"===t.code?"ETHEREUM_VIRTUAL_MACHINE.ERR_ACTION_REJECTED":"ETHEREUM_VIRTUAL_MACHINE.ERR_UNKNOWN",a=n,R=n,u=n,i=n;return"data"in t&&(a=r(t.data)),"message"in t&&(a=r(t.message)),"transaction"in t&&(a=r(t.transaction)),"reason"in t&&(a=r(t.reason)),{code:E,data:a,message:R,transaction:u,reason:i}}}var U;(U=T||(T={})).Signature={nameOf:function(e){let t=e.split(" ");if(0===t.length)return n;let E=R(t.at(1));if(E.none())return E;let a=E.unwrap(),u=R(a.split("(").at(0));if(u.none())return u;let i=u.unwrap();return r(i)}},U.SignatureBuilder=function(){let e,a,R,u,i,_;return e={name:function(n){return a=r(n),e},event:function(){return R=r("event"),e},external:function(){return R=r("external"),e},pure:function(){return u=r("pure"),e},view:function(){return u=r("view"),e},payload:function(...n){return i=r(n),e},returns:function(...n){return _=r(n),e},build:function(){if(a.none())return E("SIGNATURE_BUILDER.ERR_MISSING_NAME");let e=a.unwrap();if(R.none())return E("SIGNATURE_BUILDER.ERR_MISSING_TYPE");let r=R.unwrap();if("event"===r){let r=U.Selector.from(e,...i.unwrapOr([])),n=U.EventSignature.from(r);return t(n)}if("external"===r){let r=U.Selector.from(e,...i.unwrapOr([]));if(u.none()){let e=U.ExternalSignature.from(r);return t(e)}let n=u.unwrap();if("pure"===n){let e=U.ExternalPureSignature.from(r,..._.unwrapOr([]));return t(e)}if("view"===n){let e=U.ExternalViewSignature.from(r,..._.unwrapOr([]));return t(e)}}return E("SIGNATURE_BUILDER.ERR_MALFORMED_SIGNATURE")}},a=n,R=n,u=n,i=n,_=n,e},U.ExternalSignature={from:function(e){return`function ${e} external`}},U.ExternalViewSignature={from:function(e,...r){return`function ${e} external view returns (${U.Data.serialize(...r)})`}},U.ExternalPureSignature={from:function(e,...r){return`function ${e} external pure returns (${U.Data.serialize(...r)})`}},U.EventSignature={from:function(e){return`event ${e}`}},U.Selector={from:function(e,...r){return`${e}(${U.Data.serialize(...r)})`}},U.Data={serialize:function(...e){let r="";for(let n=0n;n<e.length;n++)0n!==n&&(r=", "),r+=e[Number(n)];return r}};export{T as EthereumVirtualMachine};//# sourceMappingURL=mod.js.map